<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Liquidaci√≥n de Deudas - Comuna de Juncal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üèõÔ∏è Sistema de Liquidaci√≥n de Deudas</h1>
            <h2>Comuna de Juncal - Servicios Rurales</h2>
        </header>

        <main>
            <div class="kpi-section">
                <div class="kpi-card" id="kpiDeuda">
                    <div class="kpi-icon">‚õΩ</div>
                    <div class="kpi-content">
                        <div class="kpi-label">Litros de Combustible Adeudados</div>
                        <div class="kpi-value"><span id="importeAdeudado">---</span></div>
                    </div>
                </div>
                <div class="kpi-card" id="kpiMora">
                    <div class="kpi-icon">‚ö†Ô∏è</div>
                    <div class="kpi-content">
                        <div class="kpi-label">Contribuyentes en Mora</div>
                        <div class="kpi-value"><span id="contribuyentesEnMora">---</span></div>
                    </div>
                </div>
                <div class="kpi-card" id="kpiAlDia">
                    <div class="kpi-icon">‚úÖ</div>
                    <div class="kpi-content">
                        <div class="kpi-label">Contribuyentes al D√≠a</div>
                        <div class="kpi-value"><span id="contribuyentesSinMora">---</span></div>
                    </div>
                </div>
            </div>

            <div class="kpi-actions">
                <button id="btnCargarKPI" class="btn-kpi" onclick="cargarKPIs()">üîÑ Actualizar Indicadores</button>
                <a href="/listado_deuda_rural" class="btn-action">üìä Ver Listado Completo</a>
                <a href="/consultas_llm" class="btn-action" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ü§ñ Consultas IA</a>
            </div>

            <div class="search-section">
                <h3>Buscar Contribuyente</h3>
                <div style="margin-bottom: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label for="valorLitro" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                üõ¢Ô∏è Valor del Litro de Combustible:
                            </label>
                            <input type="number" 
                                   id="valorLitro" 
                                   placeholder="Ej: {{ valor_litro_default }}" 
                                   step="0.01"
                                   min="0"
                                   value="{{ valor_litro_default }}"
                                   style="padding: 10px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 16px; width: 100%;">
                            <span style="margin-left: 5px; color: #666; font-size: 14px;">$/litro</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                üìÖ Calcular deuda desde:
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <select id="mesDesde" style="padding: 10px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 16px; flex: 1;">
                                    <option value="01">Enero</option>
                                    <option value="02">Febrero</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Mayo</option>
                                    <option value="06">Junio</option>
                                    <option value="07">Julio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                                <input type="number" 
                                       id="anioDesde" 
                                       placeholder="A√±o" 
                                       min="2000"
                                       max="2050"
                                       value="{{ anio_desde_default }}"
                                       style="padding: 10px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 16px; width: 100px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 15px; margin-top: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                            üîß Configuraci√≥n de Litros por Hect√°rea seg√∫n Categor√≠a:
                        </label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div>
                                <label for="litrosCat01" style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Rural Cat 01:</label>
                                <input type="number" 
                                       id="litrosCat01" 
                                       placeholder="Litros/ha" 
                                       step="0.001"
                                       min="0"
                                       value="{{ litros_cat01_default }}"
                                       style="padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 14px; width: 100%;">
                            </div>
                            <div>
                                <label for="litrosCat02" style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Rural Cat 02:</label>
                                <input type="number" 
                                       id="litrosCat02" 
                                       placeholder="Litros/ha" 
                                       step="0.001"
                                       min="0"
                                       value="{{ litros_cat02_default }}"
                                       style="padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 14px; width: 100%;">
                            </div>
                            <div>
                                <label for="litrosCat03" style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Rural Cat 3:</label>
                                <input type="number" 
                                       id="litrosCat03" 
                                       placeholder="Litros/ha" 
                                       step="0.001"
                                       min="0"
                                       value="{{ litros_cat03_default }}"
                                       style="padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" 
                           id="searchInput" 
                           placeholder="Ingrese apellido o nombre del contribuyente..."
                           autocomplete="off">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>

            <div class="info-section">
                <h3>üìã Informaci√≥n</h3>
                <ul>
                    <li>Busque el contribuyente por apellido o nombre</li>
                    <li>Seleccione el contribuyente para ver su liquidaci√≥n de deuda</li>
                    <li>El sistema calcular√° autom√°ticamente la deuda bas√°ndose en:
                        <ul>
                            <li>Cantidad de hect√°reas</li>
                            <li>Categor√≠a asignada</li>
                            <li>Valor actual del combustible</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </main>

        <footer>
            <p>¬© 2026 Comuna de Juncal - Sistema de Gesti√≥n de Servicios Rurales</p>
        </footer>
    </div>

    <script>
        // Establecer valor por defecto del mes desde el backend
        document.getElementById('mesDesde').value = '{{ mes_desde_default }}';
        
        // Funci√≥n para cargar KPIs
        function cargarKPIs() {
            const btnCargar = document.getElementById('btnCargarKPI');
            btnCargar.disabled = true;
            btnCargar.textContent = '‚è≥ Calculando...';
            
            // Obtener par√°metros de configuraci√≥n
            const valorLitro = document.getElementById('valorLitro').value || 0;
            const mesDesde = document.getElementById('mesDesde').value;
            const anioDesde = document.getElementById('anioDesde').value;
            const litrosCat01 = document.getElementById('litrosCat01').value || 1.375;
            const litrosCat02 = document.getElementById('litrosCat02').value || 1.625;
            const litrosCat03 = document.getElementById('litrosCat03').value || 1.625;
            
            // Construir URL con par√°metros
            const url = `/api/kpi_rurales?valor_litro=${valorLitro}&mes_desde=${mesDesde}&anio_desde=${anioDesde}&litros_cat01=${litrosCat01}&litros_cat02=${litrosCat02}&litros_cat03=${litrosCat03}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Formatear n√∫mero con separador de miles argentino
                    const formatearNumero = (valor) => {
                        return valor.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ".").replace(".", ",").replace(/(\d),(\d{2})$/, "$1.$2");
                    };
                    
                    // Actualizar valores - mostrar litros y pesos
                    const litrosTexto = `${formatearNumero(data.litros_adeudados)} litros`;
                    const pesosTexto = data.total_pesos > 0 ? ` ($ ${formatearNumero(data.total_pesos)})` : '';
                    document.getElementById('importeAdeudado').innerHTML = `${litrosTexto}<br><small style="color: #666;">${pesosTexto}</small>`;
                    
                    document.getElementById('contribuyentesEnMora').textContent = data.contribuyentes_en_mora;
                    document.getElementById('contribuyentesSinMora').textContent = data.contribuyentes_sin_mora;
                    
                    btnCargar.textContent = '‚úÖ Actualizar Indicadores';
                    btnCargar.disabled = false;
                })
                .catch(error => {
                    console.error('Error al cargar KPIs:', error);
                    alert('Error al cargar los indicadores. Por favor, intente nuevamente.');
                    btnCargar.textContent = 'üîÑ Actualizar Indicadores';
                    btnCargar.disabled = false;
                });
        }

        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/api/contribuyentes?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            searchResults.innerHTML = '<div class="no-results">No se encontraron contribuyentes</div>';
                            searchResults.style.display = 'block';
                            return;
                        }

                        let html = '<ul>';
                        data.forEach(contrib => {
                            const nombre = contrib.Nombre || '';
                            const nombreCompleto = `${contrib.Apellido} ${nombre}`.trim();
                            html += `
                                <li onclick="verLiquidacion(${contrib.ID_contribuyente})">
                                    <div class="contrib-info">
                                        <strong>${nombreCompleto}</strong>
                                        <span class="contrib-details">
                                            ${contrib.Terreno} has - ${contrib.Categoria} - $${contrib.ValorCategoria}/ha
                                        </span>
                                    </div>
                                </li>
                            `;
                        });
                        html += '</ul>';
                        searchResults.innerHTML = html;
                        searchResults.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        searchResults.innerHTML = '<div class="error">Error al buscar contribuyentes</div>';
                        searchResults.style.display = 'block';
                    });
            }, 300);
        });

        function verLiquidacion(idContribuyente) {
            const valorLitro = document.getElementById('valorLitro').value || 0;
            const mesDesde = document.getElementById('mesDesde').value;
            const anioDesde = document.getElementById('anioDesde').value;
            const litrosCat01 = document.getElementById('litrosCat01').value || 1.375;
            const litrosCat02 = document.getElementById('litrosCat02').value || 1.625;
            const litrosCat03 = document.getElementById('litrosCat03').value || 1.625;
            window.location.href = `/liquidacion/${idContribuyente}?valor_litro=${valorLitro}&mes_desde=${mesDesde}&anio_desde=${anioDesde}&litros_cat01=${litrosCat01}&litros_cat02=${litrosCat02}&litros_cat03=${litrosCat03}`;
        }

        // Cerrar resultados al hacer clic fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.search-box')) {
                searchResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>
